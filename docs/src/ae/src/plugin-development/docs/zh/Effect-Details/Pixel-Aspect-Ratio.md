---
title: 像素纵横比
order: 10
category:
  - AE 插件开发
---

效果必须对非正方形像素的镜头和非均匀的降频采样系数(downsampling factors)作出正确的反应。即使是不同的图层参数可以有不同的像素长宽比。一旦你理解了其中的概念，做到这一点并不难。

简单的效果不需要做任何工作来匹配[点参数](../effect-basics/parameters.html) 到输出的实际像素。点参数是根据降频采样系数和像素长宽比而给定的缩放效果；它们在输入缓冲区的坐标系中。这就提供了一个隐式的 "像素坐标系"。这个坐标系很方便，也很容易理解。但使用绝对像素测量或几何形状的效果必须更深入研究输入缓冲区和最终渲染图像之间的关系。

## 不要假设像素是方形的，或者1比1

首先，由于像素长宽比和非均匀的降频采样系数的原因，它不一定是一个正方形坐标系。相对于效果所处理的像素，最终渲染的图像可以在水平方向上被拉伸或压缩。圆形会显示为椭圆，正方形则是矩形。两点之间的距离根据它们在这个坐标系中的角度而变化；任何东西在这个系统中旋转,在最终的输出中都是倾斜的。

第二，即使它是一个正方形坐标系，也不一定与最终输出尺寸相同。这意味着任何以像素为单位定义尺寸的滑块在图像被降频采样渲染时都会出现问题；抗锯齿滤波器的宽度会根据降频采样系数而改变。

有时这些问题并不是问题。任何只基于x和y坐标的线性函数来着色像素的效果，不需要理会像素长宽比和降频采样系数。保持在输入坐标空间是一种选择，尽管你必须在其他地方考虑到像素长宽比和降频采样系数。

假设你在写一个粒子系统效果，从一个由效果控制点定义的源头位置喷出纹理精灵。使用像素坐标来表示粒子位置似乎很好（只要粒子不必绕着一个点旋转），但是当你要实际渲染粒子纹理时，你必须通过宽高像素比和降频采样系数来缩放它们。

如果一种效果已经有了坐标转换机制，还有一种更简单的方法。许多算法需要某种坐标转换；例如，使用矩阵来设置转换。但是还有其他易于适应的算法，例如纹理生成效果，它仅根据每个像素的位置计算每个像素的值。在这种情况下，代码必须采用原始像素位置，并考虑宽高像素比和降频采样系数。

## 建议方法

最简单的方法是完全用全分辨率的方形坐标工作，然后通过降频采样系数和像素长宽比进行缩放，作为最终的输出转换。由于点参数总是以输入缓冲区坐标报告，所以在使用前要将它们转换为全分辨率的方形坐标。使用这种方法，你不需要担心以像素为单位定义尺寸的滑块；只需将它们解释为以全分辨率的垂直像素来定义尺寸。

1. 获取点参数时，立即转到浮点和全分辨率方形像素系统，如下所示。

```cpp
x *= in_data>pixel_aspect_ratio.num / (float)in_data>pixel_aspect_ratio.den;
x *= in_data>downsample_x.den / (float)in_data>downsample_x.num;
y *= in_data>downsample_y.den / (float)in_data>downsample_y.num;
```

2. 在这个坐标空间中进行所有的设置(定义变换矩阵，为以后的扫描转换生成坐标，根据点之间的距离计算数值，旋转物体等等)。请注意在此阶段实际上并不是在处理像素；你只是在操作坐标或坐标变换。

3. 要回到一个与输出缓冲区的像素直接对应的坐标系，就要撤销第一步的变换。尽可能晚地这样做，以便尽可能少的代码需要处理这个非方形空间。如果你使用矩阵，这将是一个最终的输出转换。对于根据每个像素的坐标来渲染的效果来说，在对该像素进行任何处理之前，迭代输出的像素并将像素坐标转换成方形坐标。

这看起来像是额外的工作，但大多数像这样的合理复杂的效果都有一个坐标转换步骤；如果没有，它们仍然需要一个步骤来正确处理像素长宽比和降频采样系数。

## 在像素中应用用户输入

After Effects 所有的拉伸都是水平进行的，这样就不会引入不必要的场内插值；当像素作为一个单位使用时，我们认为它们是垂直像素。

## 测试测试还是测试

在 1/2、1/4 和自定义分辨率下进行测试并比较输出结果。使用变形(2:1)的像素长宽比合成来追踪像素长宽比处理中的错误(这确实使它们变得明显)，并确保使用不同的水平和垂直降频采样系数进行测试。

一些开发人员报告了一些“AE兼容”插件主机提供的降频采样系数为零的问题。在划分之前检查零。
